# Todo Item Assistant Backend

This is the backend for the **Todo Summary Assistant** application. It's built with Node.js and Express.js and provides a robust set of APIs for managing to-do items. Key functionalities include creating, retrieving, editing, and deleting todos. A standout feature is its integration with a Large Language Model (LLM) to generate meaningful summaries of unfinished todos, which can then be sent to a designated Slack channel.

## Core Features
*   **CRUD Operations for Todos**: Manage your tasks effectively.
*   **LLM-Powered Summaries**: Get intelligent summaries of your pending tasks.
*   **Slack Notifications**: Send summaries directly to your Slack workspace.
*   **Secure by Design**: Incorporates security best practices from the start.

## Security Improvements

This project has been updated with several security improvements:

1. **Security Headers**: Using Helmet.js to set secure HTTP headers
2. **Rate Limiting**: Preventing abuse with express-rate-limit
3. **Input Validation**: Validating and sanitizing all inputs with express-validator
4. **Structured Logging**: Using Winston for better logging in production
5. **RESTful API Design**: Using proper HTTP methods (GET, POST, PUT, DELETE)

## Setup

### Prerequisites

- Node.js (v14 or higher)
- npm or yarn

### Installation

1. Clone the repository
2. Install dependencies:
   ```
   npm install
   ```
3. Create a `.env` file based on the `.env.example` file:
   ```
   cp .env.example .env
   ```
4. Fill in the environment variables in the `.env` file with your actual credentials

### Environment Variables

The following environment variables need to be set in the `.env` file. Copy `.env.example` to `.env` and fill in your actual credentials.

```
PORT=3000
NODE_ENV='development' # 'production' or 'development'

# Supabase (For database)
SUPABASE_URL="<Your Supabase Project URL>"
SUPABASE_KEY="<Your Supabase Anon Key or Service Role Key>"

# Firebase (For making calls to Gemini)
# API_KEY="<Your Firebase API Key>"
# AUTH_DOMAIN="<Your Firebase Auth Domain>"
# PROJECT_ID="<Your Firebase Project ID>"
# STORAGE_BUCKET="<Your Firebase Storage Bucket>"
# APP_ID="<Your Firebase App ID>"


# Frontend
CORS_ORIGIN="<Url of your frontend app>"

# Slack Integration
SLACK_WEBHOOK_URL="<Your Slack Incoming Webhook URL>"
```

**IMPORTANT**: Never commit your `.env` file to version control. It contains sensitive credentials that should be kept private. The `npm run secure` command (if configured in your `package.json` to update `.gitignore`) helps ensure this.

### Supabase Setup (Database) ðŸ’¾

If you're using Supabase for your database and potentially authentication, follow these steps:

1.  **Create a Supabase Account**:
    *   Go to [supabase.com](https://supabase.com) and sign up for a free account or log in.
2.  **Create a New Project**:
    *   On your Supabase dashboard, click on "New project".
    *   Choose an organization (or create one).
    *   Enter a **Name** for your project (e.g., "todo-summary-app").
    *   Generate a secure **Database Password** (save this password somewhere safe, you might need it for direct database access, though for client access, API keys are typically used).
    *   Select a **Region** closest to your users.
    *   Click "Create new project". Wait for your project to be provisioned.
3.  **Get API Credentials**:
    *   Once your project is ready, navigate to **Project Settings** (the gear icon in the left sidebar).
    *   Go to the **API** section.
    *   You will find your **Project URL** (this is your `SUPABASE_URL`).
    *   You will also find your **Project API Keys**. For backend services that need to bypass Row Level Security (RLS) or perform admin tasks, you'll typically use the `service_role` key. For client-side applications, you'd use the `anon` key.
        *   Copy the **Project URL** and set it as `SUPABASE_URL` in your `backend/.env` file.
        *   Copy the appropriate **API Key** (usually the `service_role` key for backend operations) and set it as `SUPABASE_KEY` in your `backend/.env` file.
4.  **Define Your Database Schema (Tables)**:
    *   In your Supabase project dashboard, go to the **Table Editor** (table icon in the left sidebar).
    *   Create a new table for your to-do items (e.g., named `todos`).
    *   Follow this SQL table definition:
      ```sql
            create table public.todos (
            id bigint generated by default as identity not null,
            created_at timestamp with time zone not null default now(),
            title character varying not null,
            description text null,
            is_finished boolean not null default false,
            user_id uuid not null,
            constraint todos_pkey primary key (id),
            constraint todos_user_id_fkey foreign KEY (user_id) references auth.users (id) on update CASCADE on delete CASCADE
         ) TABLESPACE pg_default;
      ```
    *   Disable **Row Level Security (RLS)** on your table if it's  enabled by default, especially if you plan to access it from the frontend directly using the `anon` key.
5.  ** Set up Authentication**:
    *   Navigate to the **Authentication** section (shield icon) in your Supabase dashboard.
    *   Configure the Email authentication provider.
    * Inside the Email provider **disable** the **Confirm Email**.

Ensure your backend Supabase client (e.g., in `services/supabass-service/supabase.js`) is initialized with the `SUPABASE_URL` and `SUPABASE_KEY` from your environment variables.

### Gemini Integration Setup ðŸ¤–

To enable the to-do summarization feature, follow this [documentation](https://firebase.google.com/docs/ai-logic/get-started) to create a new Firebase Project and enable Gemini then go to project settings and add the required environment variables in the `.env` file.

### Slack Integration Setup ðŸ’¬

To send summaries to a Slack channel, configure Slack Incoming Webhooks:

1.  **Create a Slack App (if you don't have one)**:
    *   Go to the [Slack API](https://api.slack.com/apps) page.
    *   Click "Create New App" and choose "From scratch".
    *   Name your app (e.g., "Todo Backend Notifier") and select your Slack workspace.
2.  **Enable Incoming Webhooks**:
    *   In your app's settings page (usually under "Features" or "Add features and functionality"), find and select "Incoming Webhooks".
    *   Activate Incoming Webhooks using the toggle.
    *   Click "Add New Webhook to Workspace".
    *   Choose the channel where the app should post messages and click "Allow".
3.  **Copy Webhook URL**:
    *   After authorization, Slack will provide a Webhook URL (it typically starts with `https://hooks.slack.com/services/...`). Copy this URL.
4.  **Configure Backend**:
    *   Add the copied Webhook URL to your `backend/.env` file: `SLACK_WEBHOOK_URL="your_slack_webhook_url"`.
    *   The backend service responsible for sending Slack messages (e.g., `services/slack-service/webhooks.js`) should use this URL.

### Running the Application

Development mode:
```
npm run dev
```

Production mode:
```
npm start
```

## API Endpoints

### Authentication

All API endpoints require authentication using a JWT token. The token should be included in the Authorization header as a Bearer token.

### Todo Items

- `GET /api/v1/db/get-todos`: Get all todo items for the authenticated user
- `GET /api/v1/db/summarise-unfinished-todos`: Get a summary of unfinished todo items
- `POST /api/v1/db/add-todos`: Add a new todo item
- `PUT /api/v1/db/edit-todos`: Edit an existing todo item
- `DELETE /api/v1/db/delete-todos`: Delete a todo item

## Security Best Practices

1. Keep your `.env` file secure and never commit it to version control
2. Regularly update dependencies to patch security vulnerabilities
3. Use HTTPS in production
4. Implement proper authentication and authorization
5. Validate and sanitize all user inputs
